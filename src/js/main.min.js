(()=>{var c={list:[],components:new Map,isReady:!1,emit(t,e={}){document.dispatchEvent(new CustomEvent(t,{detail:e,bubbles:!0}))},init(t=document){this.emit("linkion:before-init"),t.querySelectorAll("[lnkn-data]").forEach(n=>this.initComponent(n)),this.isReady=!0,this.emit("linkion:ready")},initComponent(t){let e=t.getAttribute("lnkn-data");if(!e)return;let n=JSON.parse(e);this.add(n),this.addTemplate(n,t.outerHTML),this.emit("linkion:component:init",{el:t,component:n})},start(){this.emit("linkion:init"),this.init(),this.initAssets(),this.initScripts(),this.setListeners()},add(t){if(!t._id){this.has(t.componentName)||this.list.push(t);return}this.getComponentByProp("_id",t._id)||(this.components.set(t._id,t),this.list.push(t))},has(t){return this.components.has(t)&&(this.getComponentByProp("ref",t)||this.getComponentByProp("componentName",t))},get(t){if(this.components.has(t))return this.components.get(t);let e={};return(e=this.getComponentByProp("ref",t))||(e=this.getComponentByProp("componentName",t))?e:null},getComponentByProp(t,e){return this.list.find(n=>n[t]==e)},getComponentsByProp(t,e){return this.list.filter(n=>n[t]==e)},getCurrentComponent(t){if(!t||t.nodeType!==1)return null;let e=t.closest("[lnkn-id]");return e?this.getComponentByProp("_id",e.getAttribute("lnkn-id")):null},removeComponentByProp(t,e){this.list=this.list.filter(n=>n[t]!=e)},cleanInactiveComponents(){let t=document.querySelectorAll("[lnkn-id]"),e=[];for(let n of t)e.push(n.getAttribute("lnkn-id"));for(let n of this.components.keys())n&&!e.includes(n)&&(this.components.delete(n),this.removeComponentByProp("_id",n))}};var d={token:null,url:"/linkion/connection",getToken(){return this.token||(this.token=document.querySelector("[data-token]").getAttribute("data-token")),this.token},async fetch(t){this.token=document.querySelector("[data-token]").getAttribute("data-token");try{let e=await fetch(this.url,{method:"POST",headers:{"X-CSRF-TOKEN":this.token,Accept:"application/json","Content-Type":"application/json"},body:JSON.stringify(t)});if(!e.ok){let n=await e.text();return this.displayError(n)}return await e.json()}catch(e){return e}},updateComponent(t){let e=t.ref?t.ref:t.componentName,n=this.get(e),s=[];Object.keys(t).forEach(r=>{n[r]!==t[r]&&(n[r]=t[r],s.push(r))}),s.length!==0&&this.trigger("lnkn-updated",{componentName:n.componentName,ref:n.ref,props:s})},displayError(t){let e=document.createElement("section"),n=document.createElement("div");e.style.width="100vw",e.style.height="100vh",e.style.padding="8px",e.style.display="flex",e.style.justifyContent="center",e.style.position="absolute",e.style.top=0,e.style.zIndex=999,n.style.width="95%",n.style.backgroundColor="white",n.innerHTML=t,e.append(n),document.querySelector("body").append(e)}};var h={async load(t,e={}){if(this.has(t))return Promise.resolve(this.get(t));let n={props:{componentName:t,...e},methods:{},actions:{}};try{let s=await this.fetch(n);return this.add(s.props),this.get(t)}catch(s){return s}}};var u={async call(t,e,n=[]){let s=this.get(t),r={props:s,methods:{method:e,args:n},actions:{}};try{let o=await this.fetch(r);return this.handleEvents(o.events),this.updateComponent(o.props),(!s.componentCached||o.template)&&this.renderTemplate(s,o.template),o.result}catch(o){return console.error(o),o}}};var m={progress:null,loading:!1,fileUpload(t,e,n){let s=new XMLHttpRequest,r=new FormData,o=this.get(t);if(r.append("actions","upload"),r.append("_token",this.getToken()),r.append("props",JSON.stringify({componentName:o?o.componentName:t,prop:e})),n instanceof FileList)for(let i=0;i<n.length;i++)r.append(e+"[]",n[i]);else r.append(e,n);s.open("POST",this.url),s.setRequestHeader("X-CSRF-TOKEN",this.getToken()),s.onloadstart=()=>{this.loading=!0},s.upload.addEventListener("progress",i=>{i.lengthComputable&&(this.progress=Math.round(i.loaded/i.total*100),this.emit("upload-progress",{progress:this.progress,component:o||{componentName:t}}))}),s.onload=()=>{s.status==200?(obj=JSON.parse(s.responseText),this.updateComponent(obj.props),console.log(this.get(obj.props.componentName))):this.displayError(s.responseText),this.loading=!1},s.onerror=()=>{console.error("error")},s.send(r)}};var f={templates:new Map,addTemplate(t,e){this.hasTemplate(t.componentName)||this.templates.set(t.componentName,e)},getTemplate(t){return this.templates.get(t)},hasTemplate(t){return this.templates.has(t)},async render(t,e={},n){let s=this.get(t);if(s&&this.hasTemplate(t))return Promise.resolve(this.renderTemplate(s,this.getTemplate(t),n));let r={props:s||{componentName:t,...e},methods:{},actions:"render"};try{let o=await this.fetch(r);return s?this.updateComponent(o.props):this.add(o.props),this.renderTemplate(this.get(t),o.template,n),o.result}catch(o){return console.error(o),o}},renderTemplate(t,e,n=null){return n?this.renderComponent(t,e,n):document.querySelector(`[lnkn-id=${t._id}]`)?this.reRenderComponent(t,e):this.addTemplate(t,e)},renderComponent(t,e,n){let s=n,r=s.cloneNode(!0);r.innerHTML=e,this.init(r);let o=r.querySelectorAll("[lnkn-id]"),i=[];for(let a of o)i.push(a.getAttribute("lnkn-id"));i=i.filter(a=>a!=t._id),this.setAssets(r),s.outerHTML=r.innerHTML;for(let a of i)this.setScripts(a,r);this.setScripts(t._id,r),this.cleanInactiveComponents(),this.cleanScripts()},reRenderComponent(t,e){let n=document.querySelector(`[lnkn-id=${t._id}]`),s=document.createElement("div");s.innerHTML=e,this.init(s);let r=s.querySelectorAll("[lnkn-id]"),o=[];for(let i of r)o.push(i.getAttribute("lnkn-id"));if(o=o.filter(i=>i!=t._id),this.setAssets(s,!0),n.outerHTML=s.innerHTML,!o.length==0)for(let i of o)this.setScripts(i,s);this.setScripts(t._id,s),this.cleanInactiveComponents(),this.cleanScripts()}};var g={assets:{},head:null,body:null,getHead(){return this.head||(this.head=document.querySelector("head")),this.head},getBody(){return this.body||(this.body=document.querySelector("body")),this.body},assetsHas(t){return Object.keys(this.assets).includes(t)},assetsGet(t){return this.assets[t]},assetsSet(t,e){this.assets[t]=e},assetsAdd(t,e){this.assets[t].push(e)},componentHasAsset(t,e){if(this.assetsHas(t)){let n=this.assetsGet(t),s=!1;for(let r of n)s|=r.innerText==e.innerText;return s}return!1},initAssets(t=document){this.setAssets(t,!0)},initScripts(){this.getHead().append(...document.querySelectorAll("script[lnkn-script]"))},setAssets(t,e=!1){let n=t.querySelectorAll("[lnkn-asset]");for(let s of n){let r=s.getAttribute("lnkn-asset");this.assetsHas(r)?this.componentHasAsset(r,s)?s.remove():(e?this.getHead().append(s):[s]=this.setScriptTags([s],this.getHead(),!1),this.assetsAdd(r,s)):(e?this.getHead().append(s):[s]=this.setScriptTags([s],this.getHead(),!1),this.assetsSet(r,[s]))}},setScripts(t,e){let n=document.querySelectorAll(`script[lnkn-script=${t}]`),s=e.querySelectorAll(`script[lnkn-script=${t}]`);for(let r of n)r.remove();return this.setScriptTags(s,this.getHead()),e},cleanScripts(){let t=document.querySelectorAll("script[lnkn-script]");for(let e of t)this.components.has(e.getAttribute("lnkn-script"))||e.remove()},setScriptTags(t,e,n){let s=[];for(let r of t){let o=document.createElement("script");this.copyElement(r,o,n),r.remove(),e.append(o),s.push(o)}return s},copyElement(t,e,n=!0){for(let s of t.attributes)e.setAttribute(s.name,s.value);n?e.textContent=`(() => {${t.textContent}})();`:e.textContent=t.textContent}};var y={triggers:{},on(t,e){(this.triggers[t]??=[]).push(e)},off(t){this.triggers[t]=[]},trigger(t,e={}){(this.triggers[t]||[]).forEach(n=>n(e))},listeners:[],getListeners(t){return this.listeners.filter(e=>e.event==t)},async setListeners(){let t={actions:"getListeners"};try{let e=await this.fetch(t);for(listener of e)this.listeners.push(listener)}catch(e){console.error(e)}},dispatch(t,e={}){for(let n of this.getListeners(t)){let s=this.getComponentsByProp("componentName",n.componentName);for(let r of s)this.call(r.componentName,n.method,[e])}},handleEvents(t){t.forEach(e=>{this.emit(e.name,e.detail)})}};var T={onUpdate(t,e,n="_all_"){this.on("lnkn-updated",s=>{let{componentName:r,ref:o,props:i}=s,a,l=linkion.get(t);l&&(l.ref?a=l.ref==o:a=l.componentName==r,a&&(i.includes(n)||n=="_all_")&&e(s))})}};var p=class{static traits=[c,u,d,h,m,f,g,y,T];static register(...e){this.constructor.traits.push(...e)}constructor(){Object.assign(this,...this.constructor.traits)}};function S(t,e){return new Proxy(t,{get(n,s){if(s in n)return n[s];if(s==="then")return;let r=t.ref?t.ref:t.componentName;return s==="render"?(...o)=>e.render(r,...o):s==="upload"?(...o)=>e.fileUpload(r,...o):s==="onUpdate"?o=>e.onUpdate(r,o):s==="watch"?(o,i)=>e.onUpdate(r,i,o):(...o)=>e.call(r,s,o)},set(n,s,r){let o={};o.ref=t.ref,o.componentName=t.componentName,o[s]=r,e.updateComponent(o)}})}var C=t=>t.replace(/([a-z])([A-Z])/g,"$1.$2").toLowerCase();function k(t){return new Proxy(t,{get(e,n){if(n in e)return e[n];if(n!=="then")return e.get(n)?S(e.get(n),e):new Proxy({},{get(s,r){if(r==="render")return(...o)=>e.render(C(n),...o)}})}})}window.linkion=k(new p);queueMicrotask(()=>{window.linkion.start()});})();
