(()=>{var c={list:[],components:new Map,isReady:!1,emit(t,e={}){document.dispatchEvent(new CustomEvent(t,{detail:e,bubbles:!0}))},init(t=document){this.emit("linkion:before-init"),t.querySelectorAll("[lnkn-data]").forEach(s=>this.initComponent(s)),this.isReady=!0,this.emit("linkion:ready")},initComponent(t){let e=t.getAttribute("lnkn-data");if(!e)return;let s=JSON.parse(e);this.add(s),this.addTemplate(s,t.outerHTML),this.emit("linkion:component:init",{el:t,component:s})},start(){this.emit("linkion:init"),this.init(),this.initAssets(),this.initScripts(),this.setListeners()},add(t){if(!t._id){this.has(t.componentName)||this.list.push(t);return}this.getComponentByProp("_id",t._id)||(this.components.set(t._id,t),this.list.push(t))},has(t){return this.components.has(t)&&(this.getComponentByProp("ref",t)||this.getComponentByProp("componentName",t))},get(t){if(this.components.has(t))return this.components.get(t);let e={};return(e=this.getComponentByProp("ref",t))||(e=this.getComponentByProp("componentName",t))?e:null},getComponentByProp(t,e){return this.list.find(s=>s[t]==e)},getComponentsByProp(t,e){return this.list.filter(s=>s[t]==e)},getCurrentComponent(t){if(!t||t.nodeType!==1)return null;let e=t.closest("[lnkn-id]");return e?this.getComponentByProp("_id",e.getAttribute("lnkn-id")):null},removeComponentByProp(t,e){this.list=this.list.filter(s=>s[t]!=e)},cleanInactiveComponents(){let t=document.querySelectorAll("[lnkn-id]"),e=[];for(let s of t)e.push(s.getAttribute("lnkn-id"));for(let s of this.components.keys())s&&!e.includes(s)&&(this.components.delete(s),this.removeComponentByProp("_id",s))}};var d={token:null,url:"/linkion/connection",getToken(){return this.token||(this.token=document.querySelector("[data-token]").getAttribute("data-token")),this.token},async fetch(t){this.token=document.querySelector("[data-token]").getAttribute("data-token");try{let e=await fetch(this.url,{method:"POST",headers:{"X-CSRF-TOKEN":this.token,Accept:"application/json","Content-Type":"application/json"},body:JSON.stringify(t)});if(!e.ok){let s=await e.text();return this.displayError(s)}return await e.json()}catch(e){return e}},updateComponent(t){let e=t.ref?t.ref:t.componentName,s=this.get(e),n={};Object.keys(t).forEach(r=>{s[r]!==t[r]&&(s[r]=t[r],n[r]=s[r])}),n.length!==0&&this.trigger("lnkn-updated",{componentName:s.componentName,ref:s.ref,props:n})},displayError(t){let e=document.createElement("section"),s=document.createElement("div");e.style.width="100vw",e.style.height="100vh",e.style.padding="8px",e.style.display="flex",e.style.justifyContent="center",e.style.position="absolute",e.style.top=0,e.style.zIndex=999,s.style.width="95%",s.style.backgroundColor="white",s.innerHTML=t,e.append(s),document.querySelector("body").append(e)}};var h={async load(t,e={}){if(this.has(t))return Promise.resolve(this.get(t));let s={props:{componentName:t,...e},method:{},action:{}};try{let n=await this.fetch(s);return this.add(n.props),this.get(t)}catch(n){return n}}};var u={async call(t,e,s=[]){let n=this.get(t),r={props:n,method:{name:e,args:s},action:{}};try{let o=await this.fetch(r);return this.handleEvents(o.events),this.updateComponent(o.props),(!n.componentCached||o.template)&&this.renderTemplate(n,o.template),o.result}catch(o){return console.error(o),o}}};var m={progress:null,loading:!1,fileUpload(t,e,s){let n=new XMLHttpRequest,r=new FormData,o=this.get(t);if(!o)throw new Error("the linkion component "+t+" does not exist or is not loaded yet");if(r.append("_token",this.getToken()),r.append("action","upload"),r.append("props",JSON.stringify({componentName:o.componentName,ref:o.ref,prop:e})),s instanceof FileList)for(let i=0;i<s.length;i++)r.append(e+"[]",s[i]);else r.append(e,s);n.open("POST",this.url),n.setRequestHeader("X-CSRF-TOKEN",this.getToken()),n.onloadstart=()=>{this.loading=!0},n.upload.addEventListener("progress",i=>{i.lengthComputable&&(this.progress=Math.round(i.loaded/i.total*100),this.emit("upload-progress",{progress:this.progress,componentName:o.componentName,ref:o.ref}))}),n.onload=()=>{n.status==200?(obj=JSON.parse(n.responseText),this.updateComponent(obj.props)):this.displayError(n.responseText),this.loading=!1},n.onerror=()=>{},n.send(r)}};var f={templates:new Map,addTemplate(t,e){this.hasTemplate(t.componentName)||this.templates.set(t.componentName,e)},getTemplate(t){return this.templates.get(t)},hasTemplate(t){return this.templates.has(t)},async render(t,e={},s){let n=this.get(t);if(n&&this.hasTemplate(t))return Promise.resolve(this.renderTemplate(n,this.getTemplate(t),s));let r={props:n||{componentName:t,...e},method:{name:"render"},action:"render"};try{let o=await this.fetch(r);return n?this.updateComponent(o.props):this.add(o.props),this.renderTemplate(this.get(t),o.template,s),o.result}catch(o){return console.error(o),o}},renderTemplate(t,e,s=null){return s?this.renderComponent(t,e,s):document.querySelector(`[lnkn-id=${t._id}]`)?this.reRenderComponent(t,e):this.addTemplate(t,e)},renderComponent(t,e,s){let n=s,r=n.cloneNode(!0);r.innerHTML=e,this.init(r);let o=r.querySelectorAll("[lnkn-id]"),i=[];for(let a of o)i.push(a.getAttribute("lnkn-id"));i=i.filter(a=>a!=t._id),this.setAssets(r),n.outerHTML=r.innerHTML;for(let a of i)this.setScripts(a,r);this.setScripts(t._id,r),this.cleanInactiveComponents(),this.cleanScripts()},reRenderComponent(t,e){let s=document.querySelector(`[lnkn-id=${t._id}]`),n=document.createElement("div");n.innerHTML=e,this.init(n);let r=n.querySelectorAll("[lnkn-id]"),o=[];for(let i of r)o.push(i.getAttribute("lnkn-id"));if(o=o.filter(i=>i!=t._id),this.setAssets(n,!0),s.outerHTML=n.innerHTML,!o.length==0)for(let i of o)this.setScripts(i,n);this.setScripts(t._id,n),this.cleanInactiveComponents(),this.cleanScripts()}};var g={assets:{},head:null,body:null,getHead(){return this.head||(this.head=document.querySelector("head")),this.head},getBody(){return this.body||(this.body=document.querySelector("body")),this.body},assetsHas(t){return Object.keys(this.assets).includes(t)},assetsGet(t){return this.assets[t]},assetsSet(t,e){this.assets[t]=e},assetsAdd(t,e){this.assets[t].push(e)},componentHasAsset(t,e){if(this.assetsHas(t)){let s=this.assetsGet(t),n=!1;for(let r of s)n|=r.innerText==e.innerText;return n}return!1},initAssets(t=document){this.setAssets(t,!0)},initScripts(){this.getHead().append(...document.querySelectorAll("script[lnkn-script]"))},setAssets(t,e=!1){let s=t.querySelectorAll("[lnkn-asset]");for(let n of s){let r=n.getAttribute("lnkn-asset");this.assetsHas(r)?this.componentHasAsset(r,n)?n.remove():(e?this.getHead().append(n):[n]=this.setScriptTags([n],this.getHead(),!1),this.assetsAdd(r,n)):(e?this.getHead().append(n):[n]=this.setScriptTags([n],this.getHead(),!1),this.assetsSet(r,[n]))}},setScripts(t,e){let s=document.querySelectorAll(`script[lnkn-script=${t}]`),n=e.querySelectorAll(`script[lnkn-script=${t}]`);for(let r of s)r.remove();return this.setScriptTags(n,this.getHead()),e},cleanScripts(){let t=document.querySelectorAll("script[lnkn-script]");for(let e of t)this.components.has(e.getAttribute("lnkn-script"))||e.remove()},setScriptTags(t,e,s){let n=[];for(let r of t){let o=document.createElement("script");this.copyElement(r,o,s),r.remove(),e.append(o),n.push(o)}return n},copyElement(t,e,s=!0){for(let n of t.attributes)e.setAttribute(n.name,n.value);s?e.textContent=`(() => {${t.textContent}})();`:e.textContent=t.textContent}};var y={triggers:{},on(t,e){(this.triggers[t]??=[]).push(e)},off(t){this.triggers[t]=[]},trigger(t,e={}){(this.triggers[t]||[]).forEach(s=>s(e))},listeners:[],getListeners(t){return this.listeners.filter(e=>e.event==t)},async setListeners(){let t={action:"getListeners"};try{let e=await this.fetch(t);for(listener of e)this.listeners.push(listener)}catch(e){console.error(e)}},dispatch(t,e={}){for(let s of this.getListeners(t)){let n=this.getComponentsByProp("componentName",s.componentName);for(let r of n)this.call(r.componentName,s.method,[e])}},handleEvents(t){t.forEach(e=>{this.emit(e.name,e.detail)})}};var T={onUpdate(t,e,s="_all_"){this.on("lnkn-updated",n=>{let{componentName:r,ref:o,props:i}=n,a,l=linkion.get(t);if(l){if(l.ref?a=l.ref==o:a=l.componentName==r,a&&s=="_all_"){e(i);return}if(a&&Object.keys(i).includes(s)){e(i[s]);return}}})}};var p=class{static traits=[c,u,d,h,m,f,g,y,T];static register(...e){this.constructor.traits.push(...e)}constructor(){Object.assign(this,...this.constructor.traits)}};function S(t,e){return new Proxy(t,{get(s,n){if(n in s)return s[n];if(n==="then")return;let r=t.ref?t.ref:t.componentName;return n==="render"?(...o)=>e.render(r,...o):n==="upload"?(...o)=>e.fileUpload(r,...o):n==="onUpdate"?o=>e.onUpdate(r,o):n==="watch"?(o,i)=>e.onUpdate(r,i,o):(...o)=>e.call(r,n,o)},set(s,n,r){let o={};o.ref=t.ref,o.componentName=t.componentName,o[n]=r,e.updateComponent(o)}})}var C=t=>t.replace(/([a-z])([A-Z])/g,"$1.$2").toLowerCase();function k(t){return new Proxy(t,{get(e,s){if(s in e)return e[s];if(s!=="then")return e.get(s)?S(e.get(s),e):new Proxy({},{get(n,r){if(r==="render")return(...o)=>e.render(C(s),...o)}})}})}window.linkion=k(new p);queueMicrotask(()=>{window.linkion.start()});})();
