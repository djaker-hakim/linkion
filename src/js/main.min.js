(()=>{var p={list:[],components:new Map,isReady:!1,emit(t,e={}){document.dispatchEvent(new CustomEvent(t,{detail:e,bubbles:!0}))},init(t=document){this.emit("linkion:before-init"),this.initElement(t),this.isReady=!0,this.emit("linkion:ready")},initElement(t){t.querySelectorAll("[lnkn-data]").forEach(s=>this.initComponent(s))},initComponent(t){let e=t.getAttribute("lnkn-data");if(!e)return;let s=JSON.parse(e);this.add(s),this.addTemplate(s,t.outerHTML),this.emit("linkion:component:init",{el:t,component:s})},start(){this.emit("linkion:init"),this.init(),this.initAssets(),this.initScripts(),this.setListeners()},add(t){if(!t._id){let e=t.ref?t.ref:t.componentName;this.has(e)||this.list.push(t);return}this.components.has(t._id)||this.components.set(t._id,t),this.getComponentByProp("_id",t._id)||this.list.push(t)},has(t){return this.getComponentByProp("ref",t)||this.getComponentByProp("componentName",t)},get(t){if(this.components.has(t))return this.components.get(t);let e={};return(e=this.getComponentByProp("ref",t))||(e=this.getComponentByProp("componentName",t))?e:null},getComponentByProp(t,e){return this.list.find(s=>s[t]==e)},getComponentsByProp(t,e){return this.list.filter(s=>s[t]==e)},getCurrentComponent(t){if(!t||t.nodeType!==1)return null;let e=t.closest("[lnkn-id]");return e?this.getComponentByProp("_id",e.getAttribute("lnkn-id")):null},removeComponentByProp(t,e){this.list=this.list.filter(s=>s[t]!=e)},cleanInactiveComponents(){let t=document.querySelectorAll("[lnkn-id]"),e=[];for(let r of t)e.push(r.getAttribute("lnkn-id"));let s={};this.list.forEach(r=>s[r.ref]=(s[r.ref]||0)+1);let n=this.list.filter(r=>s[r.ref]>1);for(let r of this.components.keys())r&&!e.includes(r)&&this.components.delete(r);for(let r of n)this.components.has(r._id)||this.removeComponentByProp("_id",r._id)}};var d={token:null,url:"/linkion/connection",getToken(){return this.token||(this.token=document.querySelector("[data-token]").getAttribute("data-token")),this.token},async fetch(t){this.token=document.querySelector("[data-token]").getAttribute("data-token");try{let e=await fetch(this.url,{method:"POST",headers:{"X-CSRF-TOKEN":this.token,Accept:"application/json","Content-Type":"application/json"},body:JSON.stringify(t)});if(!e.ok){let s=await e.text();return this.displayError(s)}return await e.json()}catch(e){return e}},updateComponent(t){let e=t.ref?t.ref:t.componentName,s=this.get(e),n={};Object.keys(t).forEach(r=>{s[r]!==t[r]&&(s[r]=t[r],n[r]=s[r])}),n.length!==0&&this.trigger("lnkn-updated",{componentName:s.componentName,ref:s.ref,props:n})},displayError(t){let e=document.createElement("section"),s=document.createElement("div");e.style.width="100vw",e.style.height="100vh",e.style.padding="8px",e.style.display="flex",e.style.justifyContent="center",e.style.position="absolute",e.style.top=0,e.style.zIndex=999,s.style.width="95%",s.style.backgroundColor="white",s.innerHTML=t,e.append(s),document.querySelector("body").append(e)}};var u={async load(t,e={}){if(this.has(t))return Promise.resolve(this.get(t));let s={props:{componentName:t,...e},method:{},action:{}};try{let n=await this.fetch(s);return this.add(n.props),this.get(t)}catch(n){return n}}};var m={async call(t,e,s=[]){let n=this.get(t),r={props:n,method:{name:e,args:s},action:{}};try{let i=await this.fetch(r);return this.handleEvents(i.events),this.updateComponent(i.props),(!n.componentCached||i.template)&&this.renderTemplate(n,i.template),i.result}catch(i){return console.error(i),i}}};var f={progress:null,loading:!1,fileUpload(t,e,s){let n=new XMLHttpRequest,r=new FormData,i=this.get(t);if(!i)throw new Error("the linkion component "+t+" does not exist or is not loaded yet");if(r.append("_token",this.getToken()),r.append("action","upload"),r.append("props",JSON.stringify({componentName:i.componentName,ref:i.ref,prop:e})),s instanceof FileList)for(let o=0;o<s.length;o++)r.append(e+"[]",s[o]);else r.append(e,s);n.open("POST",this.url),n.setRequestHeader("X-CSRF-TOKEN",this.getToken()),n.onloadstart=()=>{this.loading=!0},n.upload.addEventListener("progress",o=>{o.lengthComputable&&(this.progress=Math.round(o.loaded/o.total*100),this.emit("upload-progress",{progress:this.progress,componentName:i.componentName,ref:i.ref}))}),n.onload=()=>{n.status==200?(obj=JSON.parse(n.responseText),this.updateComponent(obj.props)):this.displayError(n.responseText),this.loading=!1},n.onerror=()=>{},n.send(r)}};var g={templates:new Map,addTemplate(t,e){t.componentCached&&!this.hasTemplate(t.componentName)&&this.templates.set(t.componentName,e)},getTemplate(t){return this.templates.get(t)},hasTemplate(t){return this.templates.has(t)},async render(t,e={},s){let n=this.get(t);if(n&&this.hasTemplate(n.componentName))return Promise.resolve(this.renderTemplate(n,this.getTemplate(n.componentName),s));let r={props:n||{componentName:t,...e},method:{name:"render"},action:"render"};try{let i=await this.fetch(r);return n?this.updateComponent(i.props):this.add(i.props),this.renderTemplate(this.get(t),i.template,s),i.result}catch(i){return console.error(i),i}},renderTemplate(t,e,s=null){if(this.addTemplate(t,e),s)return this.renderComponent(t,e,s);if(document.querySelector(`[lnkn-id=${t._id}]`))return this.reRenderComponent(t,e)},renderComponent(t,e,s){let n=s,r=n.cloneNode(!0);r.innerHTML=e,this.initElement(r);let i=r.querySelectorAll("[lnkn-id]"),o=[];for(let a of i)o.push(a.getAttribute("lnkn-id"));o=o.filter(a=>a!=t._id),this.setAssets(r),n.outerHTML=r.innerHTML;for(let a of o)this.setScripts(a,r);this.setScripts(t._id,r),this.cleanInactiveComponents(),this.cleanScripts()},reRenderComponent(t,e){let s=document.querySelector(`[lnkn-id=${t._id}]`),n=document.createElement("div");n.innerHTML=e,this.initElement(n);let r=n.querySelectorAll("[lnkn-id]"),i=[];for(let o of r)i.push(o.getAttribute("lnkn-id"));if(i=i.filter(o=>o!=t._id),this.setAssets(n,!0),s.outerHTML=n.innerHTML,!i.length==0)for(let o of i)this.setScripts(o,n);this.setScripts(t._id,n),this.cleanInactiveComponents(),this.cleanScripts()}};var y={assets:{},head:null,body:null,getHead(){return this.head||(this.head=document.querySelector("head")),this.head},getBody(){return this.body||(this.body=document.querySelector("body")),this.body},assetsHas(t){return Object.keys(this.assets).includes(t)},assetsGet(t){return this.assets[t]},assetsSet(t,e){this.assets[t]=e},assetsAdd(t,e){this.assets[t].push(e)},componentHasAsset(t,e){if(this.assetsHas(t)){let s=this.assetsGet(t),n=!1;for(let r of s)n|=r.innerText==e.innerText;return n}return!1},initAssets(t=document){this.setAssets(t,!0)},initScripts(){this.getHead().append(...document.querySelectorAll("script[lnkn-script]"))},setAssets(t,e=!1){let s=t.querySelectorAll("[lnkn-asset]");for(let n of s){let r=n.getAttribute("lnkn-asset");this.assetsHas(r)?this.componentHasAsset(r,n)?n.remove():(e?this.getHead().append(n):[n]=this.setScriptTags([n],this.getHead(),!1),this.assetsAdd(r,n)):(e?this.getHead().append(n):[n]=this.setScriptTags([n],this.getHead(),!1),this.assetsSet(r,[n]))}},setScripts(t,e){let s=document.querySelectorAll(`script[lnkn-script=${t}]`),n=e.querySelectorAll(`script[lnkn-script=${t}]`);for(let r of s)r.remove();return this.setScriptTags(n,this.getHead()),e},cleanScripts(){let t=document.querySelectorAll("script[lnkn-script]");for(let e of t)this.components.has(e.getAttribute("lnkn-script"))||e.remove()},setScriptTags(t,e,s){let n=[];for(let r of t){let i=document.createElement("script");this.copyElement(r,i,s),r.remove(),e.append(i),n.push(i)}return n},copyElement(t,e,s=!0){for(let n of t.attributes)e.setAttribute(n.name,n.value);s?e.textContent=`(() => {${t.textContent}})();`:e.textContent=t.textContent}};var T={triggers:{},on(t,e,s){let n=null;return this.has(t)&&(this.triggers[t]||(this.triggers[t]={}),this.triggers[t][e]||(this.triggers[t][e]=new Map),n=crypto.randomUUID(),this.triggers[t][e].set(n,s)),n},off(t,e=null,s=null){if(this.has(t)&&!e)return delete this.triggers[t],null;this.has(t)&&this.triggers[t][e]&&(s?this.triggers[t][e].has(s)&&this.triggers[t][e].delete(s):this.triggers[t][e]=null)},offId(t){for(let e of Object.keys(this.triggers))for(let s of Object.keys(this.triggers[e]))this.triggers[e][s].has(t)&&this.triggers[e][s].delete(t)},trigger(t,e={}){for(let s of Object.keys(this.triggers))this.triggers[s][t]&&this.triggers[s][t].forEach(n=>n(e))},listeners:[],getListeners(t){return this.listeners.filter(e=>e.event==t)},async setListeners(){let t={action:"getListeners"};try{let e=await this.fetch(t);for(listener of e)this.listeners.push(listener)}catch(e){console.error(e)}},dispatch(t,e={}){for(let s of this.getListeners(t)){let n=this.getComponentsByProp("componentName",s.componentName);for(let r of n)this.call(r.componentName,s.method,[e])}},handleEvents(t){t.forEach(e=>{this.emit(e.name,e.detail)})}};var S={watchers:new Map,onUpdate(t,e,s="_all_"){if(this.has(t)){let n=this.get(t),r=`${t}:${s}:${this.hash(e.toString())}`;this.watchers.has(r)&&this.offId(this.watchers.get(r));let i=this.on(t,"lnkn-updated",o=>{let{componentName:a,ref:w,props:h}=o,l;if(n.ref?l=n.ref==w:l=n.componentName==a,l&&s=="_all_"){e(h);return}if(l&&Object.keys(h).includes(s)){e(h[s]);return}});this.watchers.set(r,i)}},hash(t){let e=0;for(let s=0;s<t.length;s++)e=Math.imul(31,e)+t.charCodeAt(s)|0;return e.toString(36)},removeWatcher(t){for(let[e,s]of this.watchers)e.split(":")[0]==t&&this.watchers.delete(e)}};var c=class{static traits=[p,m,d,u,f,g,y,T,S];static register(...e){this.constructor.traits.push(...e)}constructor(){Object.assign(this,...this.constructor.traits)}};function k(t,e){return new Proxy(t,{get(s,n){if(n in s)return s[n];if(n==="then")return;let r=t.ref?t.ref:t.componentName;return n==="render"?(...i)=>e.render(r,...i):n==="upload"?(...i)=>e.fileUpload(r,...i):n==="onUpdate"?i=>e.onUpdate(r,i):n==="watch"?(i,o)=>e.onUpdate(r,o,i):(...i)=>e.call(r,n,i)},set(s,n,r){let i={};i.ref=t.ref,i.componentName=t.componentName,i[n]=r,e.updateComponent(i)}})}var A=t=>t.replace(/([a-z])([A-Z])/g,"$1.$2").toLowerCase();function C(t){return new Proxy(t,{get(e,s){if(s in e)return e[s];if(s!=="then")return e.get(s)?k(e.get(s),e):new Proxy({},{get(n,r){if(r==="render")return(...i)=>e.render(A(s),...i)}})}})}window.linkion=C(new c);queueMicrotask(()=>{window.linkion.start()});})();
