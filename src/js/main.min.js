(()=>{var p={list:[],components:new Map,isReady:!1,emit(t,e={}){document.dispatchEvent(new CustomEvent(t,{detail:e,bubbles:!0}))},init(t=document){this.emit("linkion:before-init"),this.initElement(t),this.isReady=!0,this.emit("linkion:ready")},initElement(t){t.querySelectorAll("[lnkn-data]").forEach(s=>this.initComponent(s))},initComponent(t){let e=t.getAttribute("lnkn-data");if(!e)return;let s=JSON.parse(e);this.add(s),this.addTemplate(s,t.outerHTML),t.removeAttribute("lnkn-data")},start(){this.emit("linkion:init"),this.init(),this.initAssets(),this.initScripts(),this.setListeners()},add(t){if(!t._id){let e=t.ref?t.ref:t.componentName;this.has(e)||this.list.push(t);return}this.components.has(t._id)||this.components.set(t._id,t),this.getComponentByProp("_id",t._id)||this.list.push(t)},has(t){return this.getComponentByProp("ref",t)||this.getComponentByProp("componentName",t)},get(t){if(this.components.has(t))return this.components.get(t);let e={};return(e=this.getComponentByProp("ref",t))||(e=this.getComponentByProp("componentName",t))?e:null},getComponentByProp(t,e){return this.list.find(s=>s[t]==e)},getComponentsByProp(t,e){return this.list.filter(s=>s[t]==e)},getCurrentComponent(t){if(!t||t.nodeType!==1)return null;let e=t.closest("[lnkn-id]");return e?this.getComponentByProp("_id",e.getAttribute("lnkn-id")):null},removeComponentByProp(t,e){this.list=this.list.filter(s=>s[t]!=e)},cleanInactiveComponents(){let t=document.querySelectorAll("[lnkn-id]"),e=[];for(let n of t)e.push(n.getAttribute("lnkn-id"));let s={};this.list.forEach(n=>s[n.ref]=(s[n.ref]||0)+1);let r=this.list.filter(n=>s[n.ref]>1);for(let n of this.components.keys())n&&!e.includes(n)&&this.components.delete(n);for(let n of r)this.components.has(n._id)||this.removeComponentByProp("_id",n._id)}};var d={token:null,url:"/linkion/connection",getToken(){return this.token||(this.token=document.querySelector("[data-token]").getAttribute("data-token")),this.token},async fetch(t){this.token=document.querySelector("[data-token]").getAttribute("data-token");try{let e=await fetch(this.url,{method:"POST",headers:{"X-CSRF-TOKEN":this.token,Accept:"application/json","Content-Type":"application/json"},body:JSON.stringify(t)});if(!e.ok){let s=await e.text();return this.displayError(s)}return await e.json()}catch(e){return e}},updateComponent(t){let e=t.ref?t.ref:t.componentName,s=this.get(e),r={};Object.keys(t).forEach(n=>{s[n]!==t[n]&&(s[n]=t[n],r[n]=s[n])}),r.length!==0&&this.trigger("lnkn-updated",{componentName:s.componentName,ref:s.ref,props:r})},displayError(t){let e=document.createElement("section"),s=document.createElement("div");e.style.width="100vw",e.style.height="100vh",e.style.padding="8px",e.style.display="flex",e.style.justifyContent="center",e.style.position="absolute",e.style.top=0,e.style.zIndex=999,s.style.width="95%",s.style.backgroundColor="white",s.innerHTML=t,e.append(s),document.querySelector("body").append(e)}};var u={async load(t,e={}){if(this.has(t))return Promise.resolve(this.get(t));let s={props:{componentName:t,...e},method:{},action:{}};try{let r=await this.fetch(s);return this.add(r.props),this.get(t)}catch(r){return r}}};var m={async call(t,e,s=[]){let r=this.get(t),n={props:r,method:{name:e,args:s},action:{}};try{let i=await this.fetch(n);return this.handleEvents(i.events),this.updateComponent(i.props),(!r.componentCached||i.template)&&this.renderTemplate(r,i.template),i.result}catch(i){return console.error(i),i}}};var f={progress:null,loading:!1,fileUpload(t,e,s){let r=new XMLHttpRequest,n=new FormData,i=this.get(t);if(!i)throw new Error("the linkion component "+t+" does not exist or is not loaded yet");if(n.append("_token",this.getToken()),n.append("action","upload"),n.append("props",JSON.stringify({componentName:i.componentName,ref:i.ref,prop:e})),s instanceof FileList)for(let o=0;o<s.length;o++)n.append(e+"[]",s[o]);else n.append(e,s);r.open("POST",this.url),r.setRequestHeader("X-CSRF-TOKEN",this.getToken()),r.onloadstart=()=>{this.loading=!0},r.upload.addEventListener("progress",o=>{o.lengthComputable&&(this.progress=Math.round(o.loaded/o.total*100),this.emit("upload-progress",{progress:this.progress,componentName:i.componentName,ref:i.ref}))}),r.onload=()=>{r.status==200?(obj=JSON.parse(r.responseText),this.updateComponent(obj.props)):this.displayError(r.responseText),this.loading=!1},r.onerror=()=>{},r.send(n)}};var g={templates:new Map,addTemplate(t,e){t.componentCached&&!this.hasTemplate(t.componentName)&&this.templates.set(t.componentName,e)},getTemplate(t){return this.templates.get(t)},hasTemplate(t){return this.templates.has(t)},async render(t,e={},s){let r=this.get(t);if(r&&this.hasTemplate(r.componentName))return Promise.resolve(this.renderTemplate(r,this.getTemplate(r.componentName),s));let n={props:r||{componentName:t,...e},method:{name:"render"},action:"render"};try{let i=await this.fetch(n);return r?this.updateComponent(i.props):this.add(i.props),this.renderTemplate(this.get(t),i.template,s),i.result}catch(i){return console.error(i),i}},renderTemplate(t,e,s=null){if(this.addTemplate(t,e),s)return this.renderComponent(t,e,s);if(document.querySelector(`[lnkn-id=${t._id}]`))return this.reRenderComponent(t,e)},renderComponent(t,e,s){let r=s,n=r.cloneNode(!0);n.innerHTML=e,this.initElement(n);let i=n.querySelectorAll("[lnkn-id]"),o=[];for(let a of i)o.push(a.getAttribute("lnkn-id"));o=o.filter(a=>a!=t._id),this.setAssets(n),r.outerHTML=n.innerHTML;for(let a of o)this.setScripts(a,n);this.setScripts(t._id,n),this.cleanInactiveComponents(),this.cleanScripts()},reRenderComponent(t,e){let s=document.querySelector(`[lnkn-id=${t._id}]`),r=document.createElement("div");r.innerHTML=e,this.initElement(r);let n=r.querySelectorAll("[lnkn-id]"),i=[];for(let o of n)i.push(o.getAttribute("lnkn-id"));if(i=i.filter(o=>o!=t._id),this.setAssets(r,!0),s.outerHTML=r.innerHTML,!i.length==0)for(let o of i)this.setScripts(o,r);this.setScripts(t._id,r),this.cleanInactiveComponents(),this.cleanScripts()}};var y={assets:{},head:null,body:null,getHead(){return this.head||(this.head=document.querySelector("head")),this.head},getBody(){return this.body||(this.body=document.querySelector("body")),this.body},assetsHas(t){return Object.keys(this.assets).includes(t)},assetsGet(t){return this.assets[t]},assetsSet(t,e){this.assets[t]=e},assetsAdd(t,e){this.assets[t].push(e)},componentHasAsset(t,e){if(this.assetsHas(t)){let s=this.assetsGet(t),r=!1;for(let n of s)r|=n.innerText==e.innerText;return r}return!1},initAssets(t=document){this.setAssets(t,!0)},initScripts(){this.getHead().append(...document.querySelectorAll("script[lnkn-script]"))},setAssets(t,e=!1){let s=t.querySelectorAll("[lnkn-asset]");for(let r of s){let n=r.getAttribute("lnkn-asset");this.assetsHas(n)?this.componentHasAsset(n,r)?r.remove():(e?this.getHead().append(r):[r]=this.setScriptTags([r],this.getHead(),!1),this.assetsAdd(n,r)):(e?this.getHead().append(r):[r]=this.setScriptTags([r],this.getHead(),!1),this.assetsSet(n,[r]))}},setScripts(t,e){let s=document.querySelectorAll(`script[lnkn-script=${t}]`),r=e.querySelectorAll(`script[lnkn-script=${t}]`);for(let n of s)n.remove();return this.setScriptTags(r,this.getHead()),e},cleanScripts(){let t=document.querySelectorAll("script[lnkn-script]");for(let e of t)this.components.has(e.getAttribute("lnkn-script"))||e.remove()},setScriptTags(t,e,s){let r=[];for(let n of t){let i=document.createElement("script");this.copyElement(n,i,s),n.remove(),e.append(i),r.push(i)}return r},copyElement(t,e,s=!0){for(let r of t.attributes)e.setAttribute(r.name,r.value);s?e.textContent=`(() => {${t.textContent}})();`:e.textContent=t.textContent}};var T={triggers:{},on(t,e,s){let r=null;return this.has(t)&&(this.triggers[t]||(this.triggers[t]={}),this.triggers[t][e]||(this.triggers[t][e]=new Map),r=crypto.randomUUID(),this.triggers[t][e].set(r,s)),r},off(t,e=null,s=null){if(this.has(t)&&!e)return delete this.triggers[t],null;this.has(t)&&this.triggers[t][e]&&(s?this.triggers[t][e].has(s)&&this.triggers[t][e].delete(s):this.triggers[t][e]=null)},offId(t){for(let e of Object.keys(this.triggers))for(let s of Object.keys(this.triggers[e]))this.triggers[e][s].has(t)&&this.triggers[e][s].delete(t)},trigger(t,e={}){for(let s of Object.keys(this.triggers))this.triggers[s][t]&&this.triggers[s][t].forEach(r=>r(e))},listeners:[],getListeners(t){return this.listeners.filter(e=>e.event==t)},async setListeners(){let t={action:"getListeners"};try{let e=await this.fetch(t);for(listener of e)this.listeners.push(listener)}catch(e){console.error(e)}},dispatch(t,e={}){for(let s of this.getListeners(t)){let r=this.getComponentsByProp("componentName",s.componentName);for(let n of r)this.call(n.componentName,s.method,[e])}},handleEvents(t){t.forEach(e=>{this.emit(e.name,e.detail)})}};var S={watchers:new Map,onUpdate(t,e,s="_all_"){if(this.has(t)){let r=this.get(t),n=`${t}:${s}:${this.hash(e.toString())}`;this.watchers.has(n)&&this.offId(this.watchers.get(n));let i=this.on(t,"lnkn-updated",o=>{let{componentName:a,ref:w,props:h}=o,l;if(r.ref?l=r.ref==w:l=r.componentName==a,l&&s=="_all_"){e(h);return}if(l&&Object.keys(h).includes(s)){e(h[s]);return}});this.watchers.set(n,i)}},hash(t){let e=0;for(let s=0;s<t.length;s++)e=Math.imul(31,e)+t.charCodeAt(s)|0;return e.toString(36)},removeWatcher(t){for(let[e,s]of this.watchers)e.split(":")[0]==t&&this.watchers.delete(e)}};var c=class{static traits=[p,m,d,u,f,g,y,T,S];static register(...e){this.constructor.traits.push(...e)}constructor(){Object.assign(this,...this.constructor.traits)}};function k(t,e){return new Proxy(t,{get(s,r){if(r in s)return s[r];if(r==="then")return;let n=t.ref?t.ref:t.componentName;return r==="render"?(...i)=>e.render(n,...i):r==="upload"?(...i)=>e.fileUpload(n,...i):r==="onUpdate"?i=>e.onUpdate(n,i):r==="watch"?(i,o)=>e.onUpdate(n,o,i):(...i)=>e.call(n,r,i)},set(s,r,n){let i={};i.ref=t.ref,i.componentName=t.componentName,i[r]=n,e.updateComponent(i)}})}var A=t=>t.replace(/([a-z])([A-Z])/g,"$1.$2").toLowerCase();function C(t){return new Proxy(t,{get(e,s){if(s in e)return e[s];if(s!=="then")return e.get(s)?k(e.get(s),e):new Proxy({},{get(r,n){if(n==="render")return(...i)=>e.render(A(s),...i)}})}})}window.linkion=C(new c);queueMicrotask(()=>{window.linkion.start()});})();
